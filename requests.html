<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∏ - –ö–æ–≤—à–µ–π-–°–µ—Ä–≤–∏—Å</title>
    <link rel="stylesheet" href="styles.css">
    <style>

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .filter-group select, .filter-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .requests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .request-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .request-card:hover {
            transform: translateY(-5px);
        }

        .request-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .request-id {
            font-weight: bold;
            color: #3498db;
            font-size: 1.1em;
        }

        .request-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-draft { background: #f39c12; color: white; }
        .status-pending { background: #e74c3c; color: white; }
        .status-approved { background: #27ae60; color: white; }
        .status-completed { background: #3498db; color: white; }

        .request-details {
            margin-bottom: 15px;
        }

        .request-details p {
            margin: 5px 0;
            color: #555;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 40px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-placeholder {
            background: #f8f9fa;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .filters {
                grid-template-columns: 1fr;
            }
            
            .charts {
                grid-template-columns: 1fr;
            }
            
            .requests-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üõ†Ô∏è –ö–û–í–®–ï–ô-–°–ï–†–í–ò–°</div>
            <div class="subtitle">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Ä–µ–º–æ–Ω—Ç–∞ –∫–æ–≤—à–µ–π</div>
        </header>

        <nav>
            <ul class="nav-menu">
                <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="requests.html" class="active">–ó–∞—è–≤–∫–∏</a></li>
                <li><a href="materials.html">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</a></li>
                <li><a href="reports.html">–û—Ç—á–µ—Ç—ã</a></li>
                <li><a href="employees.html">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a></li>
                <li><a href="login.html">–í—Ö–æ–¥</a></li>
            </ul>
        </nav>

        <div class="page-header">
            <h1>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</h1>
            <p>–ü—Ä–æ—Å–º–æ—Ç—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</p>
        </div>

        <div class="content">
            <div class="filters">
                <div class="filter-group">
                    <label>–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</label>
                    <select>
                        <option>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option>–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                        <option>–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</option>
                        <option>–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</option>
                        <option>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                        <option>–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–¢–∏–ø –∫–æ–≤—à–∞</label>
                    <select>
                        <option>–í—Å–µ —Ç–∏–ø—ã</option>
                        <option>–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–Ω—ã–π</option>
                        <option>–ü–æ–≥—Ä—É–∑–æ—á–Ω—ã–π</option>
                        <option>–ö–∞—Ä—å–µ—Ä–Ω—ã–π</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–î–∞—Ç–∞ —Å</label>
                    <input type="date">
                </div>
                <div class="filter-group">
                    <label>–î–∞—Ç–∞ –ø–æ</label>
                    <input type="date">
                </div>
            </div>

            <div class="requests-grid">
                <div class="request-card">
                    <div class="request-header">
                        <div class="request-id">#–ó-2024-001</div>
                        <div class="request-status status-approved">–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</div>
                    </div>
                    <div class="request-details">
                        <p><strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:</strong> –≠–ª–µ–∫—Ç—Ä–æ–¥—ã Hardex 600</p>
                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> 25 –∫–≥</p>
                        <p><strong>–¢–∏–ø –∫–æ–≤—à–∞:</strong> –≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–Ω—ã–π 1.8–º¬≥</p>
                        <p><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> –û–û–û "–ì—Ä–∞–Ω–∏—Ç–°—Ç—Ä–æ–π"</p>
                        <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> 10.01.2024</p>
                    </div>
                    <div class="request-actions">
                        <button class="btn btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                        <button class="btn btn-success">–ü—Ä–∏–Ω—è—Ç—å</button>
                    </div>
                </div>

                <div class="request-card">
                    <div class="request-header">
                        <div class="request-id">#–ó-2024-002</div>
                        <div class="request-status status-pending">–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</div>
                    </div>
                    <div class="request-details">
                        <p><strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:</strong> –°—Ç–∞–ª—å Hardox 450</p>
                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> 3 –ª–∏—Å—Ç–∞</p>
                        <p><strong>–¢–∏–ø –∫–æ–≤—à–∞:</strong> –ü–æ–≥—Ä—É–∑–æ—á–Ω—ã–π 5.5–º¬≥</p>
                        <p><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> –ó–ê–û "–ö–∞—Ä—å–µ—Ä–°–µ–≤–µ—Ä"</p>
                        <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> 12.01.2024</p>
                    </div>
                    <div class="request-actions">
                        <button class="btn btn-primary">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                        <button class="btn btn-warning">–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å</button>
                    </div>
                </div>

                <div class="request-card">
                    <div class="request-header">
                        <div class="request-id">#–ó-2024-003</div>
                        <div class="request-status status-draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</div>
                    </div>
                    <div class="request-details">
                        <p><strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:</strong> –ü—Ä–æ–≤–æ–ª–æ–∫–∞ –ü–ü-–ê–ù170</p>
                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> 15 –∫–≥</p>
                        <p><strong>–¢–∏–ø –∫–æ–≤—à–∞:</strong> –ö–∞—Ä—å–µ—Ä–Ω—ã–π 8–º¬≥</p>
                        <p><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> –ü–ê–û "–†—É–¥–Ω–∏–∫"</p>
                        <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> 14.01.2024</p>
                    </div>
                    <div class="request-actions">
                        <button class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>

            <div class="charts">
                <div class="chart-container">
                    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—è–≤–æ–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
                    <div class="chart-placeholder">
                        –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üìà –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞—è–≤–æ–∫ –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
                    <div class="chart-placeholder">
                        –ì—Ä–∞—Ñ–∏–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞—è–≤–æ–∫ –ø–æ –º–µ—Å—è—Ü–∞–º
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>¬© 2024 –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏ "–ö–æ–≤—à–µ–π-–°–µ—Ä–≤–∏—Å". –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
        </footer>
    </div>

    <script src="app.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞—è–≤–æ–∫
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.appData) {
                loadData().then(() => {
                    initRequestsPage();
                });
            } else {
                initRequestsPage();
            }
        });

        function initRequestsPage() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            const user = getCurrentUser();
            if (!user) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.');
                window.location.href = 'login.html';
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
            updateRequestsList();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const filterSelects = document.querySelectorAll('.filters select, .filters input');
            filterSelects.forEach(filter => {
                filter.addEventListener('change', applyFilters);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
            addCreateRequestButton();
        }

        function updateRequestsList() {
            const grid = document.querySelector('.requests-grid');
            if (!grid || !window.appData || !window.appData.requests) return;
            
            grid.innerHTML = '';
            
            let requests = window.appData.requests;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞—è–≤–∫–∏ –ø–æ –ø—Ä–∞–≤–∞–º –¥–æ—Å—Ç—É–ø–∞
            const user = getCurrentUser();
            if (user) {
                if (hasPermission('canViewAllRequests')) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏
                    requests = window.appData.requests;
                } else if (hasPermission('canViewOwnRequests')) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏
                    requests = window.appData.requests.filter(r => r.createdBy === user.id);
                } else {
                    requests = [];
                }
            } else {
                requests = [];
            }
            
            requests.forEach(request => {
                const card = createRequestCard(request);
                grid.appendChild(card);
            });
        }

        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'request-card';
            card.dataset.requestId = request.id;
            
            const statusText = getStatusText(request.status);
            const statusClass = `status-${request.status}`;
            
            card.innerHTML = `
                <div class="request-header">
                    <div class="request-id">#${request.id}</div>
                    <div class="request-status ${statusClass}">${statusText}</div>
                </div>
                <div class="request-details">
                    <p><strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:</strong> ${request.material}</p>
                    <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${request.quantity}</p>
                    <p><strong>–¢–∏–ø –∫–æ–≤—à–∞:</strong> ${request.bucketType}</p>
                    <p><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> ${request.customer}</p>
                    <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${request.createdDate}</p>
                    ${request.amount ? `<p><strong>–°—É–º–º–∞:</strong> ${request.amount.toLocaleString()} ‚ÇΩ</p>` : ''}
                </div>
                <div class="request-actions">
                    <button class="btn btn-primary" onclick="showRequestDetails('${request.id}')">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                    ${getActionButtons(request)}
                </div>
            `;
            
            return card;
        }

        function getActionButtons(request) {
            const currentUser = getCurrentUser();
            if (!currentUser) return '';
            
            let buttons = '';
            const isOwner = isRequestOwner(request.id);
            
            // –ß–µ—Ä–Ω–æ–≤–∏–∫ - —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å
            if (request.status === 'draft') {
                if (isOwner && hasPermission('canEditOwnRequest')) {
                    buttons += `<button class="btn btn-primary" onclick="editRequest('${request.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`;
                }
                if (isOwner && hasPermission('canSendRequest')) {
                    buttons += `<button class="btn btn-success" onclick="sendRequest('${request.id}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>`;
                }
            } 
            // –ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ - —Ç–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –∏ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —É—Ç–≤–µ—Ä–∂–¥–∞—Ç—å/–æ—Ç–∫–ª–æ–Ω—è—Ç—å
            else if (request.status === 'pending') {
                if (hasPermission('canApproveRequest')) {
                    buttons += `<button class="btn btn-success" onclick="approveRequest('${request.id}')">–£—Ç–≤–µ—Ä–¥–∏—Ç—å</button>`;
                }
                if (hasPermission('canRejectRequest')) {
                    buttons += `<button class="btn btn-warning" onclick="rejectRequest('${request.id}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>`;
                }
            } 
            // –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ - —Ç–æ–ª—å–∫–æ –∑–∞–∫—É–ø–∫–∏ –∏ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –∑–∞–≤–µ—Ä—à–∞—Ç—å
            else if (request.status === 'approved') {
                if (hasPermission('canCompleteRequest')) {
                    buttons += `<button class="btn btn-success" onclick="completeRequest('${request.id}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`;
                }
            }
            
            // –£–¥–∞–ª–µ–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã
            if (hasPermission('canDeleteRequest')) {
                buttons += `<button class="btn btn-danger" onclick="deleteRequestConfirm('${request.id}')" style="background: #e74c3c;">–£–¥–∞–ª–∏—Ç—å</button>`;
            }
            
            return buttons;
        }

        function applyFilters() {
            const status = document.querySelector('.filters select').value;
            const bucketType = document.querySelectorAll('.filters select')[1].value;
            const dateFrom = document.querySelectorAll('.filters input')[0].value;
            const dateTo = document.querySelectorAll('.filters input')[1].value;
            
            const filters = { status, bucketType, dateFrom, dateTo };
            const filtered = filterRequests(filters);
            
            const grid = document.querySelector('.requests-grid');
            grid.innerHTML = '';
            
            filtered.forEach(request => {
                const card = createRequestCard(request);
                grid.appendChild(card);
            });
        }

        function showRequestDetails(requestId) {
            const request = window.appData.requests.find(r => r.id === requestId);
            if (!request) return;
            
            const content = `
                <div style="line-height: 1.8;">
                    <p><strong>ID:</strong> ${request.id}</p>
                    <p><strong>–ú–∞—Ç–µ—Ä–∏–∞–ª:</strong> ${request.material}</p>
                    <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${request.quantity}</p>
                    <p><strong>–¢–∏–ø –∫–æ–≤—à–∞:</strong> ${request.bucketType}</p>
                    <p><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> ${request.customer}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusText(request.status)}</p>
                    <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${request.createdDate}</p>
                    ${request.amount ? `<p><strong>–°—É–º–º–∞:</strong> ${request.amount.toLocaleString()} ‚ÇΩ</p>` : ''}
                </div>
            `;
            
            createModal('–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏', content, [
                { text: '–ó–∞–∫—Ä—ã—Ç—å', onclick: 'closeModal()', class: 'btn-primary' }
            ]);
        }

        function sendRequest(requestId) {
            if (!hasPermission('canSendRequest')) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.');
                return;
            }
            if (!isRequestOwner(requestId)) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏.');
                return;
            }
            const result = updateRequestStatus(requestId, 'pending');
            if (result.success) {
                alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ!');
                updateRequestsList();
            }
        }

        function approveRequest(requestId) {
            if (!hasPermission('canApproveRequest')) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫.');
                return;
            }
            const result = updateRequestStatus(requestId, 'approved');
            if (result.success) {
                alert('–ó–∞—è–≤–∫–∞ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!');
                updateRequestsList();
            }
        }

        function rejectRequest(requestId) {
            if (!hasPermission('canRejectRequest')) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–æ–∫.');
                return;
            }
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) {
                const result = updateRequestStatus(requestId, 'rejected');
                if (result.success) {
                    alert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.');
                    updateRequestsList();
                }
            }
        }

        function completeRequest(requestId) {
            if (!hasPermission('canCompleteRequest')) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞—è–≤–æ–∫.');
                return;
            }
            const result = updateRequestStatus(requestId, 'completed');
            if (result.success) {
                alert('–ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                updateRequestsList();
            }
        }

        function deleteRequestConfirm(requestId) {
            if (!hasPermission('canDeleteRequest')) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–æ–∫.');
                return;
            }
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) {
                const result = deleteRequest(requestId);
                if (result.success) {
                    alert('–ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞.');
                    updateRequestsList();
                }
            }
        }

        function editRequest(requestId) {
            if (!hasPermission('canEditOwnRequest')) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞—è–≤–æ–∫.');
                return;
            }
            if (!isRequestOwner(requestId)) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏.');
                return;
            }
            const request = window.appData.requests.find(r => r.id === requestId);
            if (!request) return;
            
            showRequestForm(request);
        }

        function addCreateRequestButton() {
            const pageHeader = document.querySelector('.page-header');
            if (!pageHeader) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
            if (!hasPermission('canCreateRequest')) {
                return;
            }
            
            const btn = document.createElement('button');
            btn.className = 'btn btn-success';
            btn.style.cssText = 'margin-top: 10px;';
            btn.textContent = '+ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É';
            btn.onclick = () => showRequestForm();
            pageHeader.appendChild(btn);
        }

        function showRequestForm(request = null) {
            const isEdit = !!request;
            const content = `
                <form id="requestForm" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ú–∞—Ç–µ—Ä–∏–∞–ª:</label>
                        <input type="text" id="req-material" value="${request ? request.material : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                        <input type="text" id="req-quantity" value="${request ? request.quantity : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–¢–∏–ø –∫–æ–≤—à–∞:</label>
                        <select id="req-bucketType" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–Ω—ã–π" ${request && request.bucketType.includes('–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–Ω—ã–π') ? 'selected' : ''}>–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä–Ω—ã–π</option>
                            <option value="–ü–æ–≥—Ä—É–∑–æ—á–Ω—ã–π" ${request && request.bucketType.includes('–ü–æ–≥—Ä—É–∑–æ—á–Ω—ã–π') ? 'selected' : ''}>–ü–æ–≥—Ä—É–∑–æ—á–Ω—ã–π</option>
                            <option value="–ö–∞—Ä—å–µ—Ä–Ω—ã–π" ${request && request.bucketType.includes('–ö–∞—Ä—å–µ—Ä–Ω—ã–π') ? 'selected' : ''}>–ö–∞—Ä—å–µ—Ä–Ω—ã–π</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ó–∞–∫–∞–∑—á–∏–∫:</label>
                        <input type="text" id="req-customer" value="${request ? request.customer : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">–°—É–º–º–∞ (‚ÇΩ):</label>
                        <input type="number" id="req-amount" value="${request ? request.amount : ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                </form>
            `;
            
            const modal = createModal(isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É' : '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É', content, [
                { text: '–û—Ç–º–µ–Ω–∞', onclick: 'closeModal()', class: 'btn-secondary' },
                { text: isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å', onclick: `saveRequestForm('${request ? request.id : ''}')`, class: 'btn-success' }
            ]);
        }

        function saveRequestForm(requestId) {
            const material = document.getElementById('req-material').value;
            const quantity = document.getElementById('req-quantity').value;
            const bucketType = document.getElementById('req-bucketType').value;
            const customer = document.getElementById('req-customer').value;
            const amount = parseFloat(document.getElementById('req-amount').value) || 0;
            
            if (!material || !quantity || !bucketType || !customer) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                return;
            }
            
            if (requestId) {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                const request = window.appData.requests.find(r => r.id === requestId);
                if (request) {
                    request.material = material;
                    request.quantity = quantity;
                    request.bucketType = bucketType;
                    request.customer = customer;
                    request.amount = amount;
                    request.updatedAt = new Date().toISOString();
                    saveData();
                    alert('–ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    closeModal();
                    updateRequestsList();
                }
            } else {
                // –°–æ–∑–¥–∞–Ω–∏–µ
                const result = addRequest({ material, quantity, bucketType, customer, amount });
                if (result.success) {
                    alert('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                    closeModal();
                    updateRequestsList();
                }
            }
        }
    </script>
</body>
</html>